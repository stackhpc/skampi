{{ if .Values.dshlmc.enabled }}

{{- $chart_name := .Chart.Name -}}

{{- $release_namespace := .Release.Namespace -}}
{{- $release_name := .Release.Name -}}
{{- $release_service := .Release.Service -}}

{{- $dsh_lmc_prototype_name :=  default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix "-" -}}

{{- $image_reg := .Values.dshlmc.image.registry -}}
{{- $image_image := .Values.dshlmc.image.image -}}
{{- $image_tag := .Values.dshlmc.image.tag -}}
{{- $image_pull_policy := .Values.dshlmc.image.pullPolicy -}}

{{- $db_db := .Values.dshlmc.db.db -}}
{{- $db_user := .Values.dshlmc.db.user -}}
{{- $db_password := .Values.dshlmc.db.password -}}


{{- range tuple "1" "2" }}
---
apiVersion: v1
kind: Pod
metadata:
  name: dsh-lmc-prototype-{{ $dsh_lmc_prototype_name }}-{{ $release_name }}-{{ . }}
  namespace: {{ $release_namespace }}
  labels:
    app: dshlmc-{{ $dsh_lmc_prototype_name }}-{{ $release_name }}
    chart: {{ $dsh_lmc_prototype_name }}
    release: {{ $release_name }}
    heritage: {{ $release_service }}
spec:
  initContainers:
  - name: dsh-lmc-config-{{ . }}
    image: "{{ $image_reg }}/{{ $image_image }}:{{ $image_tag }}"
    imagePullPolicy: {{ $image_pull_policy }}
    command:
      - /bin/bash
    args:
      - -c
      - "sed -i \"s/ska-lmc-vm:10000/$TANGO_HOST/g\" ./config/sample_config.json &&\
         sed -i \"s/0001/000{{ . }}/g\" ./config/sample_config.json &&\
         sed -i \"s/0001/000{{ . }}/g\"  ./ansible/roles/configure/defaults/main.yml  &&\
         sed -i \"s/0001/000{{ . }}/g\"  ./ansible/roles/configure/templates/lmc_cfg.j2  &&\
         sed -i \"s/: \\\"1\\\"/: \\\"{{ . }}\\\"/g\" .//ansible/roles/configure/defaults/main.yml &&\
         ./scripts/configure_lmc.sh --no-rootpass --config=./config/sample_config.json"
    env:
    - name: TANGO_HOST
      value: databaseds-tango-base-{{ $release_name }}:10000
    - name: MYSQL_HOST
      value: tangodb-tango-base-{{ $release_name }}:3306
    - name: MYSQL_DATABASE
      value: "{{ $db_db }}"
    - name: MYSQL_USER
      value: "{{ $db_user }}"
    - name: MYSQL_PASSWORD
      value: "{{ $db_password }}"
  containers:
  - name: dish-master-{{ . }}
    image: "{{ $image_reg }}/{{ $image_image }}:{{ $image_tag }}"
    imagePullPolicy: {{ $image_pull_policy }}
    command:
       - sh
    args:
       - -c
       - "./bin/dish-master {{ . }}"
    env:
    - name: TANGO_HOST
      value: databaseds-tango-base-{{ $release_name }}:10000
    - name: MYSQL_HOST
      value: tangodb-tango-base-{{ $release_name }}:3306
    - name: MYSQL_DATABASE
      value: "{{ $db_db }}"
    - name: MYSQL_USER
      value: "{{ $db_user }}"
    - name: MYSQL_PASSWORD
      value: "{{ $db_password }}"

  - name: ds-simulator-{{ . }}
    image: "{{ $image_reg }}/{{ $image_image }}:{{ $image_tag }}"
    imagePullPolicy: {{ $image_pull_policy }}
    command:
       - sh
    args:
       - -c
       - "./bin/ds-simulator {{ . }}"
    env:
    - name: TANGO_HOST
      value: databaseds-tango-base-{{ $release_name }}:10000
    - name: MYSQL_HOST
      value: tangodb-tango-base-{{ $release_name }}:3306
    - name: MYSQL_DATABASE
      value: "{{ $db_db }}"
    - name: MYSQL_USER
      value: "{{ $db_user }}"
    - name: MYSQL_PASSWORD
      value: "{{ $db_password }}"

  - name: dsctrl-simulator-{{ . }}
    image: "{{ $image_reg }}/{{ $image_image }}:{{ $image_tag }}"
    imagePullPolicy: {{ $image_pull_policy }}
    command:
       - sh
    args:
       - -c
       - "./bin/dsctrl-simulator {{ . }}"
    env:
    - name: TANGO_HOST
      value: databaseds-tango-base-{{ $release_name }}:10000
    - name: MYSQL_HOST
      value: tangodb-tango-base-{{ $release_name }}:3306
    - name: MYSQL_DATABASE
      value: "{{ $db_db }}"
    - name: MYSQL_USER
      value: "{{ $db_user }}"
    - name: MYSQL_PASSWORD
      value: "{{ $db_password }}"

  - name: lmc-logger-{{ . }}
    image: "{{ $image_reg }}/{{ $image_image }}:{{ $image_tag }}"
    imagePullPolicy: {{ $image_pull_policy }}
    command:
       - sh
    args:
       - -c
       - "./bin/lmc-logger {{ . }}"
    env:
    - name: TANGO_HOST
      value: databaseds-tango-base-{{ $release_name }}:10000
    - name: MYSQL_HOST
      value: tangodb-tango-base-{{ $release_name }}:3306
    - name: MYSQL_DATABASE
      value: "{{ $db_db }}"
    - name: MYSQL_USER
      value: "{{ $db_user }}"
    - name: MYSQL_PASSWORD
      value: "{{ $db_password }}"

  - name: pdu-manager-{{ . }}
    image: "{{ $image_reg }}/{{ $image_image }}:{{ $image_tag }}"
    imagePullPolicy: {{ $image_pull_policy }}
    command:
       - sh
    args:
       - -c
       - "sleep infinity"
    env:
    - name: TANGO_HOST
      value: databaseds-tango-base-{{ $release_name }}:10000
    - name: MYSQL_HOST
      value: tangodb-tango-base-{{ $release_name }}:3306
    - name: MYSQL_DATABASE
      value: "{{ $db_db }}"
    - name: MYSQL_USER
      value: "{{ $db_user }}"
    - name: MYSQL_PASSWORD
      value: "{{ $db_password }}"

  - name: pdu-simulator-{{ . }}
    image: "{{ $image_reg }}/{{ $image_image }}:{{ $image_tag }}"
    imagePullPolicy: {{ $image_pull_policy }}
    command:
       - sh
    args:
       - -c
       - "./bin/pdu-simulator {{ . }}"
    env:
    - name: TANGO_HOST
      value: databaseds-tango-base-{{ $release_name }}:10000
    - name: MYSQL_HOST
      value: tangodb-tango-base-{{ $release_name }}:3306
    - name: MYSQL_DATABASE
      value: "{{ $db_db }}"
    - name: MYSQL_USER
      value: "{{ $db_user }}"
    - name: MYSQL_PASSWORD
      value: "{{ $db_password }}"

  - name: rx-simulator-{{ . }}
    image: "{{ $image_reg }}/{{ $image_image }}:{{ $image_tag }}"
    imagePullPolicy: {{ $image_pull_policy }}
    command:
       - sh
    args:
       - -c
       - "./bin/rx-simulator {{ . }}"
    env:
    - name: TANGO_HOST
      value: databaseds-tango-base-{{ $release_name }}:10000
    - name: MYSQL_HOST
      value: tangodb-tango-base-{{ $release_name }}:3306
    - name: MYSQL_DATABASE
      value: "{{ $db_db }}"
    - name: MYSQL_USER
      value: "{{ $db_user }}"
    - name: MYSQL_PASSWORD
      value: "{{ $db_password }}"

  - name: spf-simulator-{{ . }}
    image: "{{ $image_reg }}/{{ $image_image }}:{{ $image_tag }}"
    imagePullPolicy: {{ $image_pull_policy }}
    command:
       - sh
    args:
       - -c
       - "./bin/spf-simulator {{ . }}"
    env:
    - name: TANGO_HOST
      value: databaseds-tango-base-{{ $release_name }}:10000
    - name: MYSQL_HOST
      value: tangodb-tango-base-{{ $release_name }}:3306
    - name: MYSQL_DATABASE
      value: "{{ $db_db }}"
    - name: MYSQL_USER
      value: "{{ $db_user }}"
    - name: MYSQL_PASSWORD
      value: "{{ $db_password }}"


{{- end }}

{{ end }}